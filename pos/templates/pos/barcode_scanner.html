
{% extends "pos/base.html" %}
{% load static %}

{% block title %}Barcode Scanner{% endblock %}

{% block extra_css %}
<style>
    #interactive {
        position: relative;
        width: 100%;
        height: 400px;
        overflow: hidden;
        background: #000;
    }
    .scanner-crosshair {
        position: absolute;
        border: 2px solid #8B4513;
        border-radius: 20px;
        box-shadow: 0 0 0 4px rgba(139, 69, 19, 0.3);
        width: 80%;
        height: 80%;
        top: 10%;
        left: 10%;
        z-index: 10;
        pointer-events: none;
    }
    .scanner-controls {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
    }
    .scanner-controls button {
        margin: 0 0.5rem;
    }
    #scan-result {
        margin-top: 1rem;
        text-align: center;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="glass-panel p-6 animate-in">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Barcode Scanner</h1>
            <a href="{% url 'pos_home' %}" class="text-[#8B4513] hover:underline flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Back to POS
            </a>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <div class="mb-4">
                    <h2 class="text-lg font-medium mb-2">Manual Entry</h2>
                    <div class="flex">
                        <input type="text" id="manual-barcode-input" class="form-control" placeholder="Enter barcode number">
                        <button id="manual-submit" class="btn btn-primary ml-2">Submit</button>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-lg font-medium mb-2">Camera Scanner</h2>
                    <p class="text-gray-600 text-sm mb-3">Position the barcode within the box and hold steady.</p>
                    
                    <div id="interactive" class="rounded-lg shadow-md">
                        <div class="scanner-crosshair"></div>
                    </div>
                    
                    <div class="scanner-controls">
                        <button id="start-scanner" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M2 10h20"/></svg>
                            Start Camera
                        </button>
                        <button id="stop-scanner" class="btn btn-outline" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M2 10h20"/></svg>
                            Stop Camera
                        </button>
                    </div>
                </div>
            </div>
            
            <div>
                <div id="scan-result" class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-gray-500">Scan a barcode or enter one manually to see the result</p>
                </div>
                
                <div id="product-details" class="mt-6 hidden">
                    <h2 class="text-lg font-medium mb-2">Product Details</h2>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="w-20 h-20 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
                                <img id="product-image" src="" alt="Product" class="w-full h-full object-cover">
                            </div>
                            <div class="ml-4">
                                <h3 id="product-name" class="font-medium"></h3>
                                <p id="product-price" class="text-[#8B4513] font-bold"></p>
                                <p id="product-stock" class="text-sm text-gray-600"></p>
                                <button id="add-to-cart" class="mt-2 btn btn-primary btn-sm">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<script src="{% static 'js/camera-scanner.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create a new CameraScanner instance
        const scanner = new CameraScanner({
            onBarcodeDetected: handleBarcodeDetection,
            onScannerError: handleScannerError,
            targetElement: 'interactive',
            crosshairId: 'scanner-crosshair'
        });
        
        // Variables
        let lastScannedCode = '';
        let lastScannedTime = 0;
        let currentProduct = null;
        
        // DOM elements
        const startScannerBtn = document.getElementById('start-scanner');
        const stopScannerBtn = document.getElementById('stop-scanner');
        const manualBarcodeInput = document.getElementById('manual-barcode-input');
        const manualSubmitBtn = document.getElementById('manual-submit');
        const scanResult = document.getElementById('scan-result');
        const productDetails = document.getElementById('product-details');
        const productImage = document.getElementById('product-image');
        const productName = document.getElementById('product-name');
        const productPrice = document.getElementById('product-price');
        const productStock = document.getElementById('product-stock');
        const addToCartBtn = document.getElementById('add-to-cart');
        
        // Event listeners
        startScannerBtn.addEventListener('click', () => {
            scanner.start();
            startScannerBtn.disabled = true;
            stopScannerBtn.disabled = false;
        });
        
        stopScannerBtn.addEventListener('click', () => {
            scanner.stop();
            startScannerBtn.disabled = false;
            stopScannerBtn.disabled = true;
        });
        
        manualSubmitBtn.addEventListener('click', handleManualSubmit);
        manualBarcodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleManualSubmit();
            }
        });
        
        addToCartBtn.addEventListener('click', () => {
            if (currentProduct) {
                addProductToCart(currentProduct);
            }
        });
        
        // Handler functions
        function handleManualSubmit() {
            const barcode = manualBarcodeInput.value.trim();
            if (barcode) {
                processBarcode(barcode);
                manualBarcodeInput.value = '';
            } else {
                showToast('Please enter a barcode number', 'error');
            }
        }
        
        function handleBarcodeDetection(barcode) {
            // Prevent multiple scans of the same barcode in a short time
            const now = Date.now();
            if (barcode === lastScannedCode && now - lastScannedTime < 2000) {
                return;
            }
            
            lastScannedCode = barcode;
            lastScannedTime = now;
            
            // Play beep sound
            const beep = new Audio('/static/sounds/beep.mp3');
            beep.play();
            
            // Vibrate if supported
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            processBarcode(barcode);
        }
        
        function handleScannerError(error) {
            console.error('Scanner error:', error);
            showToast('Error: ' + error.message, 'error');
            
            // Re-enable start button
            startScannerBtn.disabled = false;
            stopScannerBtn.disabled = true;
        }
        
        function processBarcode(barcode) {
            // Display the scanned barcode
            scanResult.innerHTML = `
                <p class="text-lg">Scanned Barcode:</p>
                <p class="text-2xl text-[#8B4513] font-bold">${barcode}</p>
            `;
            
            // Fetch product information
            fetch(`/pos/api/products/barcode/${barcode}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProductDetails(data.product);
                    } else {
                        productDetails.classList.add('hidden');
                        showToast('Product not found for this barcode', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error fetching product:', error);
                    showToast('Error looking up product', 'error');
                });
        }
        
        function displayProductDetails(product) {
            currentProduct = product;
            
            productImage.src = product.image || '/static/images/placeholder.svg';
            productImage.onerror = () => {
                productImage.src = '/static/images/placeholder.svg';
            };
            
            productName.textContent = product.name;
            productPrice.textContent = `â‚±${parseFloat(product.price).toFixed(2)}`;
            productStock.textContent = `In Stock: ${product.stock}`;
            
            addToCartBtn.disabled = product.stock <= 0;
            if (product.stock <= 0) {
                productStock.classList.add('text-red-500');
                productStock.textContent = 'Out of Stock';
            } else {
                productStock.classList.remove('text-red-500');
            }
            
            productDetails.classList.remove('hidden');
        }
        
        function addProductToCart(product) {
            // Send to server or local storage
            fetch('/pos/api/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    product_id: product.id,
                    quantity: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Added ${product.name} to cart`, 'success');
                    
                    // Redirect to POS home after short delay
                    setTimeout(() => {
                        window.location.href = "{% url 'pos_home' %}";
                    }, 1500);
                } else {
                    showToast(data.message || 'Error adding to cart', 'error');
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                showToast('Error adding to cart', 'error');
            });
        }
        
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'fixed top-4 right-4 z-50 flex flex-col gap-2';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `p-3 rounded shadow-lg flex items-center gap-2 animate-in slide-in-from-right duration-200 max-w-xs text-sm ${
                type === 'success' ? 'bg-green-100 text-green-800 border-l-4 border-green-500' : 
                type === 'error' ? 'bg-red-100 text-red-800 border-l-4 border-red-500' : 
                'bg-blue-100 text-blue-800 border-l-4 border-blue-500'
            }`;
            
            toast.innerHTML = `
                <div class="flex-shrink-0">
                    ${type === 'success' ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>' : 
                    type === 'error' ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>' : 
                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>'}
                </div>
                <div>${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after delay
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    toast.remove();
                    if (toastContainer.children.length === 0) {
                        toastContainer.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length, cookie.length);
                }
            }
            return '';
        }
    });
</script>
{% endblock %}
