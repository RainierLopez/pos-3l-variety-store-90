
{% extends "pos/base.html" %}
{% load static %}

{% block title %}POS - Variety Store{% endblock %}

{% block extra_css %}
<style>
    .glass-panel {
        background-color: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .animate-in {
        animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }
    .product-card {
        transition: all 0.2s ease;
    }
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .btn {
        @apply px-4 py-2 rounded-md text-sm font-medium transition-colors;
    }
    .btn-primary {
        @apply bg-[#8B4513] text-white hover:bg-[#A0522D];
    }
    .btn-outline {
        @apply border border-gray-300 hover:border-[#8B4513] hover:text-[#8B4513];
    }
    .form-control {
        @apply px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#8B4513] focus:border-transparent;
    }
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(139, 69, 19, 0.1);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(139, 69, 19, 0.5);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 69, 19, 0.7);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto" x-data="posApp()">
    <div class="glass-panel p-6 animate-in">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Product Catalog - 2 columns on large screens -->
            <div class="lg:col-span-2 space-y-6" :class="{ 'hidden lg:block': isProductCatalogCollapsed }">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h2 class="text-2xl font-bold text-[#8B4513]">Products</h2>
                    <div class="flex gap-2">
                        <a href="{% url 'inventory_management' %}" class="btn btn-outline flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M12.74 2.32a1 1 0 0 0-1.48 0l-9 10A1 1 0 0 0 3 14h2v7a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-7h2a1 1 0 0 0 .78-1.63l-9-10z"/></svg>
                            Inventory
                        </a>
                        <a href="{% url 'sales_report' %}" class="btn btn-outline flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                            Reports
                        </a>
                    </div>
                </div>
                
                <div class="flex gap-4 flex-wrap">
                    <div class="relative flex-grow">
                        <input 
                            type="text" 
                            x-model="searchQuery" 
                            placeholder="Search products..." 
                            class="form-control pl-10 w-full"
                        >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-3 text-gray-400"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                    
                    <div class="flex-none">
                        <select x-model="categoryFilter" class="form-control">
                            <option value="">All Categories</option>
                            {% for value, label in categories %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="product-grid custom-scrollbar max-h-[70vh] overflow-y-auto pr-2 pb-4">
                    <template x-for="product in filteredProducts" :key="product.id">
                        <div 
                            class="product-card bg-white rounded-lg shadow-md overflow-hidden"
                            :class="{ 'border-2 border-[#8B4513]': product.stock <= 0 }"
                        >
                            <div 
                                class="h-40 bg-gray-200 relative" 
                                :class="{ 'bg-gray-300': product.stock <= 0 }"
                            >
                                <img 
                                    :src="product.image || '{% static 'images/placeholder.svg' %}'" 
                                    :alt="product.name"
                                    class="w-full h-full object-cover"
                                    :class="{ 'opacity-50': product.stock <= 0 }"
                                >
                                <span 
                                    x-show="product.stock <= 0" 
                                    class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold"
                                >
                                    Out of stock
                                </span>
                            </div>
                            <div class="p-4">
                                <h3 class="font-medium line-clamp-1" x-text="product.name"></h3>
                                <p class="text-[#8B4513] font-bold" x-text="`â‚±${product.price.toFixed(2)}`"></p>
                                <p class="text-sm text-gray-500" x-text="`Stock: ${product.stock}`"></p>
                                <button 
                                    @click="addToCart(product)"
                                    class="mt-2 w-full btn btn-primary"
                                    :disabled="product.stock <= 0"
                                    :class="{ 'opacity-50 cursor-not-allowed': product.stock <= 0 }"
                                >
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="filteredProducts.length === 0" class="col-span-full text-center py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-300 mb-4"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <p class="text-gray-500">No products found</p>
                    </div>
                </div>
            </div>
            
            <!-- Cart Summary - 1 column on large screens -->
            <div class="glass-panel p-6 rounded-xl shadow-md">
                <div class="space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-[#8B4513]">Cart</h2>
                        <div class="flex gap-2">
                            <div class="flex gap-2 relative">
                                <input 
                                    type="text" 
                                    x-model="barcodeInput" 
                                    @keydown.enter="searchByBarcode"
                                    placeholder="Enter barcode..." 
                                    class="w-40 pl-9 rounded-full bg-white border-2 border-[#8B4513] focus-visible:ring-[#8B4513] form-control"
                                >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-2.5 text-[#8B4513]"><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></svg>
                                <button 
                                    @click="searchByBarcode"
                                    class="rounded-full btn btn-primary h-9"
                                >
                                    Scan
                                </button>
                            </div>
                            <button
                                class="btn btn-outline rounded-full shadow-md hover:shadow-lg transition-all hover:border-[#8B4513] lg:hidden"
                                @click="toggleProductCatalog"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1 lg:hidden"><path d="M20 12H4"/><path d="M20 18H4"/><path d="M20 6H4"/></svg>
                                <span class="lg:hidden">Menu</span>
                            </button>
                        </div>
                    </div>

                    <div class="max-h-[400px] overflow-y-auto pr-2 space-y-4 custom-scrollbar">
                        <template x-for="(item, index) in cart" :key="index">
                            <div class="flex items-center justify-between bg-white p-4 rounded-lg">
                                <div class="flex-1">
                                    <h3 class="font-medium" x-text="item.name"></h3>
                                    <p class="text-sm text-gray-500" x-text="`â‚±${item.price.toFixed(2)} Ã— ${item.quantity}`"></p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button
                                        @click="updateCartItem(item.id, -1)"
                                        class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 hover:border-[#8B4513] hover:text-[#8B4513]"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
                                    </button>
                                    <span class="w-8 text-center" x-text="item.quantity"></span>
                                    <button
                                        @click="updateCartItem(item.id, 1)"
                                        class="w-8 h-8 flex items-center justify-center rounded-md border border-gray-300 hover:border-[#8B4513] hover:text-[#8B4513]"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                    </button>
                                    <button
                                        @click="removeFromCart(item.id)"
                                        class="w-8 h-8 flex items-center justify-center rounded-md bg-red-500 text-white hover:bg-red-600"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                    </button>
                                </div>
                            </div>
                        </template>

                        <div x-show="cart.length === 0" class="text-center py-12">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-300 mb-4"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                            <p class="text-gray-500 text-lg">Cart is empty. Add some products!</p>
                        </div>
                    </div>

                    <div x-show="cart.length > 0 && !paymentComplete" class="mt-6 space-y-6 border-t pt-6">
                        <div x-show="!showPaymentMethods">
                            <div class="flex justify-between mb-4 items-center">
                                <span class="font-bold text-lg">Total:</span>
                                <span class="font-bold text-xl text-[#8B4513]" x-text="`â‚±${calculateTotal().toFixed(2)}`"></span>
                            </div>
                            <button
                                @click="showPaymentMethods = true"
                                class="w-full h-12 text-lg rounded-full shadow-lg hover:shadow-xl transition-all btn btn-primary"
                            >
                                Checkout
                            </button>
                        </div>

                        <div x-show="showPaymentMethods" class="animate-in">
                            <div class="border-t pt-4">
                                <h3 class="font-medium mb-2">Select Payment Method</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <button
                                        @click="selectPaymentMethod('cash')"
                                        class="btn"
                                        :class="selectedPaymentMethod === 'cash' ? 'btn-primary' : 'btn-outline'"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>
                                        Cash
                                    </button>
                                    <button
                                        @click="selectPaymentMethod('card')"
                                        class="btn"
                                        :class="selectedPaymentMethod === 'card' ? 'btn-primary' : 'btn-outline'"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                                        Card
                                    </button>
                                    <button
                                        @click="selectPaymentMethod('wallet')"
                                        class="btn"
                                        :class="selectedPaymentMethod === 'wallet' ? 'btn-primary' : 'btn-outline'"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                                        E-Wallet
                                    </button>
                                </div>
                            </div>

                            <div x-show="selectedPaymentMethod === 'card'" class="rounded-lg bg-white p-4 shadow-inner border border-gray-100 mt-4 animate-in">
                                <form @submit.prevent="processPayment" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
                                        <input 
                                            type="text" 
                                            x-model="cardDetails.cardNumber" 
                                            placeholder="XXXX XXXX XXXX XXXX" 
                                            class="form-control w-full"
                                            required
                                        >
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                                            <input 
                                                type="text" 
                                                x-model="cardDetails.expiryDate" 
                                                placeholder="MM/YY" 
                                                class="form-control w-full"
                                                required
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
                                            <input 
                                                type="text" 
                                                x-model="cardDetails.cvv" 
                                                placeholder="XXX" 
                                                class="form-control w-full"
                                                required
                                            >
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full btn btn-primary">
                                        Pay Now
                                    </button>
                                </form>
                            </div>

                            <div x-show="selectedPaymentMethod === 'wallet'" class="rounded-lg bg-white p-4 shadow-inner border border-gray-100 mt-4 animate-in">
                                <div class="text-center">
                                    <img src="{% static 'images/qr-placeholder.png' %}" alt="QR Code" class="mx-auto h-48 w-48 object-contain mb-4">
                                    <p class="text-sm text-gray-600 mb-4">
                                        Scan the QR code with your e-wallet app, then upload the payment receipt.
                                    </p>
                                    <input 
                                        type="file" 
                                        id="receipt-upload" 
                                        accept="image/*"
                                        class="hidden"
                                        @change="handleFileUpload"
                                    >
                                    <button
                                        @click="document.getElementById('receipt-upload').click()"
                                        class="w-full btn btn-primary"
                                    >
                                        Upload Receipt
                                    </button>
                                </div>
                            </div>

                            <div x-show="selectedPaymentMethod === 'cash'" class="mt-4">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Contact (Optional)</label>
                                        <input 
                                            type="text" 
                                            x-model="customerContact" 
                                            placeholder="Phone number" 
                                            class="form-control w-full"
                                        >
                                    </div>
                                </div>
                                <button
                                    @click="processPayment"
                                    class="w-full btn btn-primary"
                                >
                                    Complete Cash Payment
                                </button>
                            </div>

                            <div class="border-t mt-4 pt-4">
                                <div class="flex justify-between mb-4 items-center">
                                    <span class="font-bold text-lg">Total:</span>
                                    <span class="font-bold text-xl text-[#8B4513]" x-text="`â‚±${calculateTotal().toFixed(2)}`"></span>
                                </div>
                                <button
                                    @click="showPaymentMethods = false"
                                    class="w-full btn btn-outline"
                                >
                                    Back to Cart
                                </button>
                            </div>
                        </div>
                    </div>

                    <div x-show="paymentComplete" class="mt-6 space-y-6 animate-in">
                        <div class="p-6 rounded-lg shadow-inner border text-center">
                            <template x-if="selectedPaymentMethod === 'cash'">
                                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-yellow-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>
                                    <p class="font-medium text-lg">Pending Payment</p>
                                    <p class="text-base" x-text="`Total Bill: â‚±${calculateTotal().toFixed(2)}`"></p>
                                    <p class="text-base">Method: Cash</p>
                                </div>
                            </template>
                            <template x-if="selectedPaymentMethod !== 'cash'">
                                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 text-green-700">
                                    <template x-if="selectedPaymentMethod === 'card'">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                                    </template>
                                    <template x-if="selectedPaymentMethod === 'wallet'">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                                    </template>
                                    <p class="font-medium text-lg">Payment Successful!</p>
                                    <p class="text-base" x-text="`Total paid: â‚±${calculateTotal().toFixed(2)}`"></p>
                                    <p class="text-base" x-text="`Method: ${selectedPaymentMethod === 'card' ? 'Card Payment' : 'E-Wallet'}`"></p>
                                </div>
                            </template>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button
                                @click="printReceipt"
                                class="w-full h-12 shadow-md hover:shadow-lg transition-all rounded-full btn btn-outline"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                                <span x-text="selectedPaymentMethod === 'cash' ? 'Print Initial Receipt' : 'Print Receipt'"></span>
                            </button>
                            <button
                                @click="resetTransaction"
                                class="w-full h-12 shadow-md hover:shadow-lg transition-all rounded-full btn btn-primary"
                            >
                                New Transaction
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function posApp() {
        return {
            products: JSON.parse('{{ products|escapejs|safe }}'),
            cart: JSON.parse('{{ cart|escapejs|safe }}' || '[]'),
            searchQuery: '',
            categoryFilter: '',
            barcodeInput: '',
            isProductCatalogCollapsed: false,
            showPaymentMethods: false,
            selectedPaymentMethod: null,
            customerContact: '',
            cardDetails: {
                cardNumber: '',
                expiryDate: '',
                cvv: ''
            },
            paymentComplete: false,
            currentTransactionId: null,
            
            get filteredProducts() {
                return this.products.filter(product => {
                    const matchesSearch = product.name.toLowerCase().includes(this.searchQuery.toLowerCase());
                    const matchesCategory = !this.categoryFilter || product.category === this.categoryFilter;
                    return matchesSearch && matchesCategory;
                });
            },
            
            toggleProductCatalog() {
                this.isProductCatalogCollapsed = !this.isProductCatalogCollapsed;
            },
            
            addToCart(product) {
                if (product.stock <= 0) return;
                
                // Check if product already in cart
                const existingItemIndex = this.cart.findIndex(item => item.id === product.id);
                
                if (existingItemIndex !== -1) {
                    // Update quantity
                    this.cart[existingItemIndex].quantity += 1;
                } else {
                    // Add new item
                    this.cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: 1,
                        image: product.image,
                        barcode: product.barcode
                    });
                }
                
                this.updateServerCart();
                this.showToast(`Added ${product.name} to cart`);
            },
            
            updateCartItem(productId, change) {
                const itemIndex = this.cart.findIndex(item => item.id === productId);
                if (itemIndex === -1) return;
                
                const newQuantity = this.cart[itemIndex].quantity + change;
                
                if (newQuantity <= 0) {
                    this.removeFromCart(productId);
                    return;
                }
                
                this.cart[itemIndex].quantity = newQuantity;
                this.updateServerCart();
            },
            
            removeFromCart(productId) {
                const itemIndex = this.cart.findIndex(item => item.id === productId);
                if (itemIndex === -1) return;
                
                const productName = this.cart[itemIndex].name;
                this.cart.splice(itemIndex, 1);
                this.updateServerCart();
                this.showToast(`Removed ${productName} from cart`);
            },
            
            calculateTotal() {
                return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            },
            
            updateServerCart() {
                fetch('{% url "update_cart_item" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ cart: this.cart })
                });
            },
            
            searchByBarcode() {
                if (!this.barcodeInput) return;
                
                fetch(`{% url "get_product_by_barcode" barcode="PLACEHOLDER" %}`.replace('PLACEHOLDER', this.barcodeInput))
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Product not found');
                        }
                        return response.json();
                    })
                    .then(product => {
                        this.addToCart(product);
                        this.barcodeInput = '';
                    })
                    .catch(error => {
                        this.showToast(`Error: ${error.message}`, true);
                    });
            },
            
            selectPaymentMethod(method) {
                this.selectedPaymentMethod = method;
            },
            
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.processPayment(file);
            },
            
            processPayment(fileOrEvent) {
                // Validate payment details based on method
                if (this.selectedPaymentMethod === 'card') {
                    if (!this.cardDetails.cardNumber || !this.cardDetails.expiryDate || !this.cardDetails.cvv) {
                        this.showToast('Please fill in all card details', true);
                        return;
                    }
                }
                
                // Create transaction
                fetch('{% url "create_transaction" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        payment_method: this.selectedPaymentMethod,
                        customer_contact: this.customerContact
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.currentTransactionId = data.transaction.id;
                        
                        // Handle additional payment details if needed
                        if (this.selectedPaymentMethod === 'card') {
                            // Save card details
                            fetch(`/pos/api/transactions/${this.currentTransactionId}/card-details/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify(this.cardDetails)
                            });
                        } else if (this.selectedPaymentMethod === 'wallet' && fileOrEvent instanceof File) {
                            // Upload receipt image
                            const formData = new FormData();
                            formData.append('receipt_image', fileOrEvent);
                            
                            fetch(`/pos/api/transactions/${this.currentTransactionId}/upload-receipt/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: formData
                            });
                        }
                        
                        // Mark payment as complete
                        this.paymentComplete = true;
                        this.showToast('Transaction completed successfully');
                    } else {
                        this.showToast(`Error: ${data.error}`, true);
                    }
                })
                .catch(error => {
                    this.showToast(`Error: ${error.message}`, true);
                });
            },
            
            printReceipt() {
                if (!this.currentTransactionId) return;
                
                window.open(`{% url "print_receipt" transaction_id="PLACEHOLDER" %}`.replace('PLACEHOLDER', this.currentTransactionId), '_blank');
            },
            
            resetTransaction() {
                this.cart = [];
                this.updateServerCart();
                this.paymentComplete = false;
                this.currentTransactionId = null;
                this.showPaymentMethods = false;
                this.selectedPaymentMethod = null;
                this.customerContact = '';
                this.cardDetails = {
                    cardNumber: '',
                    expiryDate: '',
                    cvv: ''
                };
            },
            
            showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
        };
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
