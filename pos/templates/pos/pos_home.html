
{% extends 'pos/base.html' %}
{% load static %}

{% block title %}Point of Sale - Variety Store{% endblock %}

{% block extra_css %}
<style>
    .glass-panel {
        background-color: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(139, 69, 19, 0.1);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(139, 69, 19, 0.5);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 69, 19, 0.7);
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6" x-data="posApp()">
    <!-- Product Catalog -->
    <div class="lg:col-span-2" x-show="!isProductCatalogCollapsed" x-transition>
        <div class="glass-panel p-6 rounded-xl shadow-lg border border-white border-opacity-30 bg-white bg-opacity-80">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-[#8B4513]">Products</h2>
                <div class="flex gap-2">
                    <button @click="selectedCategory = 'meat'" :class="{'bg-[#8B4513] text-white': selectedCategory === 'meat', 'bg-white text-gray-700': selectedCategory !== 'meat'}" class="px-4 py-2 rounded-full shadow-md transition-all hover:scale-105">
                        Meat
                    </button>
                    <button @click="selectedCategory = 'vegetable'" :class="{'bg-[#8B4513] text-white': selectedCategory === 'vegetable', 'bg-white text-gray-700': selectedCategory !== 'vegetable'}" class="px-4 py-2 rounded-full shadow-md transition-all hover:scale-105">
                        Vegetable
                    </button>
                    <button @click="isProductCatalogCollapsed = true" class="p-2 bg-white rounded-full shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex gap-2 relative">
                    <input
                        type="text"
                        placeholder="Search products..."
                        x-model="searchQuery"
                        class="flex-1 pl-10 rounded-full bg-white border-2 border-[#8B4513] focus:ring-[#8B4513] px-4 py-2"
                    />
                    <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-3 text-[#8B4513] h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <template x-for="product in filteredProducts" :key="product.id">
                    <button
                        @click="addToCart(product)"
                        class="p-4 bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-left flex flex-col h-full border border-gray-100 hover:border-[#8B4513] hover:scale-105 group"
                    >
                        <div class="flex-shrink-0 h-32 w-full mb-2 overflow-hidden rounded-md bg-gray-100 relative">
                            <img 
                                :src="product.image || '{% static 'images/placeholder.svg' %}'" 
                                :alt="product.name"
                                class="h-full w-full object-cover transition-all group-hover:scale-110"
                                @error="$event.target.src='{% static 'images/placeholder.svg' %}'"
                            />
                            <div class="absolute bottom-0 right-0 bg-[#8B4513] text-white text-xs px-2 py-1 rounded-tl-md" x-text="'#' + product.barcode.slice(-4)"></div>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium line-clamp-2 group-hover:text-[#8B4513]" x-text="product.name"></h3>
                            <p class="text-[#8B4513] font-bold text-lg" x-text="'₱' + product.price.toFixed(2)"></p>
                            <div class="mt-1 flex items-center justify-between">
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded-full text-gray-700" x-text="'Stock: ' + product.stock"></span>
                                <span class="text-xs text-[#8B4513] opacity-0 group-hover:opacity-100 transition-opacity">
                                    Add to cart
                                </span>
                            </div>
                        </div>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- Cart Summary -->
    <div :class="{'col-span-3': isProductCatalogCollapsed}" class="glass-panel p-6 rounded-xl shadow-lg border border-white border-opacity-30 bg-white bg-opacity-80">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-[#8B4513]">Cart</h2>
            <div class="flex gap-2">
                <div class="flex gap-2 relative">
                    <input 
                        type="text"
                        placeholder="Enter barcode..."
                        x-model="barcodeInput"
                        @keydown.enter="handleBarcodeSearch"
                        class="w-40 pl-9 rounded-full bg-white border-2 border-[#8B4513] focus-visible:ring-[#8B4513]"
                    />
                    <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-2.5 text-[#8B4513] h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7V4m0 0h3m-3 0H4m0 14h3m-3 3v-3m3 3h7m4-3v3m0 0h3m-3 0v-3m0 0h3m-3-7h3m-3-6h3" />
                    </svg>
                    <button 
                        @click="handleBarcodeSearch"
                        class="rounded-full h-9"
                        style="background-color: #8B4513; color: white"
                    >
                        Scan
                    </button>
                </div>
                <a
                    href="{% url 'transactions_list' %}"
                    class="flex items-center gap-2 rounded-full shadow-md hover:shadow-lg transition-all hover:border-[#8B4513] border border-gray-300 px-3 py-1"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                    </svg>
                    Transactions
                </a>
                <button 
                    @click="isProductCatalogCollapsed = !isProductCatalogCollapsed" 
                    class="p-2 bg-white rounded-full shadow-md"
                    x-show="isProductCatalogCollapsed"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="space-y-4">
            <div class="max-h-[400px] overflow-y-auto pr-2 space-y-4 custom-scrollbar">
                <template x-if="cart.length === 0">
                    <div class="text-center py-12">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                        </svg>
                        <p class="text-gray-500 text-lg">Cart is empty. Add some products!</p>
                    </div>
                </template>
                
                <template x-for="item in cart" :key="item.id">
                    <div class="flex items-center justify-between bg-white p-4 rounded-lg">
                        <div class="flex-1">
                            <h3 class="font-medium" x-text="item.name"></h3>
                            <p class="text-sm text-gray-500" x-text="'₱' + item.price.toFixed(2) + ' × ' + item.quantity"></p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button @click="updateQuantity(item.id, -1)" class="border border-gray-300 rounded-md p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                </svg>
                            </button>
                            <span class="w-8 text-center" x-text="item.quantity"></span>
                            <button @click="updateQuantity(item.id, 1)" class="border border-gray-300 rounded-md p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                            <button @click="removeFromCart(item.id)" class="bg-red-500 text-white rounded-md p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <template x-if="cart.length > 0 && !paymentComplete">
                <div class="mt-6 space-y-6 border-t pt-6">
                    <!-- Payment Methods -->
                    <div class="border-t pt-4">
                        <h3 class="font-medium mb-2">Select Payment Method</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button 
                                @click="selectPaymentMethod('cash')"
                                :class="{'bg-[#8B4513] text-white': selectedPaymentMethod === 'cash', 'bg-white text-gray-700 border border-gray-300': selectedPaymentMethod !== 'cash'}"
                                class="w-full px-3 py-2 rounded-md flex items-center justify-center"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                Cash
                            </button>
                            <button 
                                @click="selectPaymentMethod('card')"
                                :class="{'bg-[#8B4513] text-white': selectedPaymentMethod === 'card', 'bg-white text-gray-700 border border-gray-300': selectedPaymentMethod !== 'card'}"
                                class="w-full px-3 py-2 rounded-md flex items-center justify-center"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                                Card
                            </button>
                            <button 
                                @click="selectPaymentMethod('wallet')"
                                :class="{'bg-[#8B4513] text-white': selectedPaymentMethod === 'wallet', 'bg-white text-gray-700 border border-gray-300': selectedPaymentMethod !== 'wallet'}"
                                class="w-full px-3 py-2 rounded-md flex items-center justify-center"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                E-Wallet
                            </button>
                        </div>
                    </div>

                    <!-- Card Payment Form -->
                    <div x-show="showCardForm" class="rounded-lg bg-white p-4 shadow-inner border border-gray-100">
                        <h3 class="font-medium mb-3">Card Details</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Card Number</label>
                                <input 
                                    type="text" 
                                    x-model="cardDetails.cardNumber" 
                                    placeholder="1234 5678 9012 3456" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                    maxlength="19"
                                    @input="formatCardNumber"
                                />
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Expiry Date</label>
                                    <input 
                                        type="text" 
                                        x-model="cardDetails.expiryDate" 
                                        placeholder="MM/YY" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        maxlength="5"
                                        @input="formatExpiryDate"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">CVV</label>
                                    <input 
                                        type="text" 
                                        x-model="cardDetails.cvv" 
                                        placeholder="123" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                        maxlength="3"
                                    />
                                </div>
                            </div>
                            <button 
                                @click="submitCardPayment"
                                class="w-full py-2 mt-3 rounded-md"
                                style="background-color: #8B4513; color: white;"
                            >
                                Process Payment
                            </button>
                        </div>
                    </div>

                    <!-- E-Wallet Payment Form -->
                    <div x-show="showEWalletForm" class="rounded-lg bg-white p-4 shadow-inner border border-gray-100">
                        <h3 class="font-medium mb-3">E-Wallet Payment</h3>
                        <p class="text-sm text-gray-600 mb-3">Please upload a screenshot of your e-wallet payment receipt:</p>
                        <form 
                            id="ewallet-form" 
                            enctype="multipart/form-data" 
                            method="post" 
                            :action="'/api/transactions/' + currentTransaction + '/upload-receipt/'"
                            class="hidden"
                        >
                            {% csrf_token %}
                            <input type="file" name="receipt" id="receipt-file" accept="image/*" @change="handleFileUpload">
                        </form>
                        <div class="border-2 border-dashed border-gray-300 p-4 rounded-md text-center">
                            <label for="receipt-file" class="block cursor-pointer">
                                <span class="text-blue-500 hover:text-blue-600">Choose file</span> or drag and drop
                            </label>
                            <div x-show="ewalletFile" class="mt-3">
                                <p class="text-green-600 text-sm" x-text="'Selected: ' + ewalletFile.name"></p>
                                <img x-show="ewalletPreview" :src="ewalletPreview" class="mt-2 max-h-40 mx-auto" />
                            </div>
                        </div>
                        <button 
                            @click="submitEWalletPayment"
                            class="w-full py-2 mt-3 rounded-md"
                            :disabled="!ewalletFile"
                            :class="{'opacity-50 cursor-not-allowed': !ewalletFile}"
                            style="background-color: #8B4513; color: white;"
                        >
                            Process Payment
                        </button>
                    </div>
                    
                    <div class="border-t pt-6">
                        <div class="flex justify-between mb-4 items-center">
                            <span class="font-bold text-lg">Total:</span>
                            <span class="font-bold text-xl text-[#8B4513]" x-text="'₱' + total.toFixed(2)"></span>
                        </div>
                        <div x-show="!showCardForm && !showEWalletForm">
                            <button
                                @click="processPayment"
                                class="w-full h-12 text-lg rounded-full shadow-lg hover:shadow-xl transition-all"
                                style="background-color: #8B4513; color: white;"
                                :disabled="!selectedPaymentMethod"
                                :class="{'opacity-50 cursor-not-allowed': !selectedPaymentMethod}"
                            >
                                Pay Now
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <template x-if="paymentComplete">
                <div class="mt-6 space-y-6 animate-in">
                    <div class="p-6 rounded-lg shadow-inner border text-center">
                        <template x-if="selectedPaymentMethod === 'cash'">
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-yellow-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <p class="font-medium text-lg">Pending Payment</p>
                                <p class="text-base" x-text="'Total Bill: ₱' + total.toFixed(2)"></p>
                                <p class="text-base">Method: Cash</p>
                            </div>
                        </template>
                        <template x-if="selectedPaymentMethod !== 'cash'">
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 text-green-700">
                                <svg x-show="selectedPaymentMethod === 'card'" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                                <svg x-show="selectedPaymentMethod === 'wallet'" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                <p class="font-medium text-lg">Payment Successful!</p>
                                <p class="text-base" x-text="'Total paid: ₱' + total.toFixed(2)"></p>
                                <p class="text-base" x-text="'Method: ' + getPaymentMethodName(selectedPaymentMethod)"></p>
                            </div>
                        </template>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <a 
                            :href="'/print-receipt/' + currentTransaction"
                            target="_blank"
                            class="w-full h-12 shadow-md hover:shadow-lg transition-all rounded-full border border-gray-300 bg-white flex items-center justify-center gap-2 text-gray-700"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                            </svg>
                            <span x-text="selectedPaymentMethod === 'cash' ? 'Print Initial Receipt' : 'Print Receipt'"></span>
                        </a>
                        <button
                            @click="resetTransaction"
                            class="w-full h-12 shadow-md hover:shadow-lg transition-all rounded-full text-white flex items-center justify-center gap-2"
                            style="background-color: #8B4513;"
                        >
                            New Transaction
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Customer Phone Modal -->
    <div x-show="showPhoneModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-medium mb-4">Enter Customer Phone Number</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Phone Number</label>
                    <input 
                        type="tel" 
                        x-model="customerPhone"
                        placeholder="e.g., 09123456789" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                </div>
                <div class="flex justify-end space-x-3">
                    <button 
                        @click="showPhoneModal = false" 
                        class="px-4 py-2 border border-gray-300 rounded-md"
                    >
                        Cancel
                    </button>
                    <button 
                        @click="confirmPhoneNumber" 
                        class="px-4 py-2 rounded-md text-white"
                        style="background-color: #8B4513;"
                    >
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function posApp() {
        return {
            products: {{ products|safe }},
            cart: [],
            searchQuery: '',
            barcodeInput: '',
            selectedCategory: 'meat',
            selectedPaymentMethod: null,
            showCardForm: false,
            showEWalletForm: false,
            cardDetails: {
                cardNumber: '',
                expiryDate: '',
                cvv: ''
            },
            ewalletFile: null,
            ewalletPreview: null,
            paymentComplete: false,
            currentTransaction: null,
            showPhoneModal: false,
            customerPhone: '',
            isProductCatalogCollapsed: false,
            
            init() {
                // Try to load cart from localStorage
                const savedCart = localStorage.getItem('cart');
                if (savedCart) {
                    this.cart = JSON.parse(savedCart);
                }
            },
            
            get filteredProducts() {
                return this.products.filter(product => 
                    product.category === this.selectedCategory && 
                    (this.searchQuery === '' || 
                     product.name.toLowerCase().includes(this.searchQuery.toLowerCase()) || 
                     product.barcode.includes(this.searchQuery))
                );
            },
            
            get total() {
                return this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            },
            
            addToCart(product) {
                const existingItem = this.cart.find(item => item.id === product.id);
                
                if (existingItem) {
                    this.updateQuantity(product.id, 1);
                } else {
                    this.cart.push({...product, quantity: 1});
                    this.saveCart();
                    this.showToast('Product Added', `${product.name} has been added to your cart.`);
                }
            },
            
            updateQuantity(productId, change) {
                const index = this.cart.findIndex(item => item.id === productId);
                if (index !== -1) {
                    const newQuantity = this.cart[index].quantity + change;
                    
                    if (newQuantity <= 0) {
                        this.removeFromCart(productId);
                    } else {
                        this.cart[index].quantity = newQuantity;
                        this.saveCart();
                    }
                }
            },
            
            removeFromCart(productId) {
                this.cart = this.cart.filter(item => item.id !== productId);
                this.saveCart();
            },
            
            saveCart() {
                localStorage.setItem('cart', JSON.stringify(this.cart));
            },
            
            handleBarcodeSearch() {
                if (!this.barcodeInput) return;
                
                fetch(`/api/products/barcode/${this.barcodeInput}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.addToCart(data.product);
                            this.barcodeInput = '';
                        } else {
                            this.showToast('Product Not Found', 'No product matches this barcode.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.showToast('Error', 'Failed to search for product.', 'error');
                    });
            },
            
            selectPaymentMethod(method) {
                this.selectedPaymentMethod = method;
                this.showCardForm = method === 'card';
                this.showEWalletForm = method === 'wallet';
            },
            
            formatCardNumber() {
                let value = this.cardDetails.cardNumber.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = '';
                
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formattedValue += ' ';
                    }
                    formattedValue += value[i];
                }
                
                this.cardDetails.cardNumber = formattedValue;
            },
            
            formatExpiryDate() {
                let value = this.cardDetails.expiryDate.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                
                if (value.length > 2) {
                    this.cardDetails.expiryDate = value.substring(0, 2) + '/' + value.substring(2, 4);
                } else {
                    this.cardDetails.expiryDate = value;
                }
            },
            
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.ewalletFile = file;
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = e => {
                        this.ewalletPreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            processPayment() {
                if (!this.selectedPaymentMethod) return;
                
                if (this.selectedPaymentMethod === 'cash') {
                    this.createTransaction();
                } else if (this.selectedPaymentMethod === 'card') {
                    this.showCardForm = true;
                } else if (this.selectedPaymentMethod === 'wallet') {
                    this.showEWalletForm = true;
                }
            },
            
            submitCardPayment() {
                // Validate card details
                if (!this.cardDetails.cardNumber || !this.cardDetails.expiryDate || !this.cardDetails.cvv) {
                    this.showToast('Invalid Card Details', 'Please fill in all card fields.', 'error');
                    return;
                }
                
                if (this.cardDetails.cardNumber.length < 16) {
                    this.showToast('Invalid Card Number', 'Please enter a valid card number.', 'error');
                    return;
                }
                
                this.createTransaction();
            },
            
            submitEWalletPayment() {
                if (!this.ewalletFile) {
                    this.showToast('Missing Receipt', 'Please upload a receipt image.', 'error');
                    return;
                }
                
                this.createTransaction();
            },
            
            createTransaction() {
                // For cash transactions, get customer phone number
                if (this.selectedPaymentMethod === 'cash') {
                    this.showPhoneModal = true;
                    return;
                }
                
                this.finalizeTransaction();
            },
            
            confirmPhoneNumber() {
                this.showPhoneModal = false;
                this.finalizeTransaction();
            },
            
            finalizeTransaction() {
                const transactionData = {
                    items: this.cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        barcode: item.barcode || ''
                    })),
                    total: this.total,
                    payment_method: this.selectedPaymentMethod,
                    customer_contact: this.customerPhone || null
                };
                
                if (this.selectedPaymentMethod === 'card') {
                    transactionData.card_details = {
                        card_number: this.cardDetails.cardNumber.slice(-4),
                        expiry_date: this.cardDetails.expiryDate
                    };
                }
                
                // First create the transaction
                fetch('/api/transactions/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(transactionData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.currentTransaction = data.transaction_id;
                        
                        // If this is an e-wallet payment, upload the receipt image
                        if (this.selectedPaymentMethod === 'wallet' && this.ewalletFile) {
                            const formData = new FormData();
                            formData.append('receipt', this.ewalletFile);
                            
                            return fetch(`/api/transactions/${data.transaction_id}/upload-receipt/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: formData
                            })
                            .then(response => response.json());
                        }
                        
                        return { success: true };
                    } else {
                        throw new Error(data.message || 'Failed to create transaction');
                    }
                })
                .then(data => {
                    if (data.success) {
                        this.paymentComplete = true;
                        this.showToast('Transaction Complete', 'Your transaction has been processed.', 'success');
                        
                        // Clear the cart in localStorage
                        localStorage.removeItem('cart');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.showToast('Transaction Failed', error.message || 'An error occurred while processing your transaction.', 'error');
                });
            },
            
            resetTransaction() {
                this.cart = [];
                this.selectedPaymentMethod = null;
                this.showCardForm = false;
                this.showEWalletForm = false;
                this.cardDetails = { cardNumber: '', expiryDate: '', cvv: '' };
                this.ewalletFile = null;
                this.ewalletPreview = null;
                this.paymentComplete = false;
                this.currentTransaction = null;
                this.customerPhone = '';
                
                localStorage.removeItem('cart');
            },
            
            getPaymentMethodName(method) {
                switch (method) {
                    case 'card': return 'Card Payment';
                    case 'wallet': return 'E-Wallet';
                    case 'cash': return 'Cash';
                    default: return 'Unknown';
                }
            },
            
            showToast(title, message, type = 'info') {
                // Create toast notification
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                    type === 'error' ? 'bg-red-100 text-red-700 border-red-200' : 
                    type === 'success' ? 'bg-green-100 text-green-700 border-green-200' : 
                    'bg-blue-100 text-blue-700 border-blue-200'
                } border animate-in`;
                
                toast.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">${title}</h3>
                            <p class="text-sm">${message}</p>
                        </div>
                        <button class="ml-4 text-gray-500 hover:text-gray-700">×</button>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                // Add click event to close button
                toast.querySelector('button').addEventListener('click', () => {
                    toast.remove();
                });
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.classList.add('fade-out');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
            }
        };
    }
</script>
{% endblock %}
